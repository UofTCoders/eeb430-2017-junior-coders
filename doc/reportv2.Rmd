---
title: "Final Project"
author: "Farhan Majumder, Leila Krichel, Rui Zhou, Jeffrey Nguyen"
date: "December 5, 2017"
output:
  html_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r,warning=FALSE, include=FALSE}

## The Team Theme

jrc_theme <- function() {
    theme(
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(fill = NA),
        axis.line = element_line(),
        #text = element_text(size = 11, family = "Times"),
        panel.background = element_blank(),
        panel.grid.major = element_line(colour = "grey91"),
        panel.grid.minor = element_blank(),
        legend.position = "right",
        axis.text.x = element_text(angle = 45,hjust = 1))
}

```


```{r,warning=FALSE, include=FALSE}



library(tidyverse)
library(dplyr)
library(readxl)
library(broom)
library(ggplot2)
library(lme4)
library(MuMIn)
library(knitr)
library(plotly)

```


```{r,warning=FALSE, include=FALSE}



Pred <- read_csv("../data/predator.csv.gz",na = c("","n/a","NA"),col_types = cols(`SD PP`=col_double()))
colnames(Pred) <- gsub(" ", "_", colnames(Pred))

Pred <- Pred %>%
mutate(Specific_habitat=gsub("Coastal bay", "Coastal Bay", Specific_habitat)) %>%
mutate(Specific_habitat=gsub("shelf", "Shelf", Specific_habitat))

pred_prey_dataset <- Pred %>%
    group_by(Predator_common_name, 
             Prey_common_name, 
             Specific_habitat, 
             Type_of_feeding_interaction, 
             Predator_lifestage, 
             Mean_PP,
             Mean_annual_temp,
             Depth) #%>%


```

# Introduction

Animals come in many different shapes and sizes and they can be seen interacting with each other in many forms.  One type of interaction between organisms is the predator-prey interaction which allows us to generate food webs.  Cohen et al(1993) was able to determine that most predators that we see are bigger than the prey that they eat and there is a positive correlation for size increase in predators when prey size increases.  Animals that eat at a higer trophic levels don't neccessary have larger predator-prey ratios as discovered by Tucker and Rogers(2014) for marine and terrestrial mammals. There have been many other experiments that compare the mass of predators to the mass of prey and they overall agree that there is a relationship between predator-prey mass. However, are there other factors that can affect this relationship?

From the *Marine predator and prey body sizes* dataset created by Barnes et al (2008), we want to show that location and feeding behavior are just two of the aforementioned factors that could influence this interaction. The dataset contains a vast amount of information that comes from 27 marine locations with 93 types of predators and prey.  




```{r,echo=FALSE,fig.width=7, fig.height=6,warning=FALSE,fig.cap=paste("Fig.1: *Shows the log of Predator mass vs log of Prey Mass*")}

 pred_prey_dataset %>% 
     ggplot(aes(x = log(Predator_mass), y = log(Prey_mass))) +
     geom_hex(bin=50) +
     geom_smooth(method = "glm", colour = "Red") +
    xlab("Log (Predator Mass)")+
    ylab("Log (Prey Mass)")+
    jrc_theme()


```



```{r,echo=FALSE,fig.width=8, fig.height=6,warning=FALSE,fig.cap=paste("Fig.1: *Shows the log of Predator mass vs log of Prey Mass*")}

Pred %>% 
     group_by(Specific_habitat) %>% 
    tally()%>% 
      ggplot(aes(x=Specific_habitat, y=n, fill = Specific_habitat))+
     geom_bar(stat = "identity")+
     jrc_theme()+
    xlab("Specific Habitat")+
    ylab("Number of Samples")+
    labs(color='Specific Habitat')+
    scale_fill_discrete(name = "Specific Habitat")
   



```


```{r, fig.width=9, fig.height=5, echo=FALSE,fig.cap=paste("Fig.2: *Shows the log of Predator mass vs log of Prey Mass by Specific Habitat*")}

pred_prey_dataset %>% 
    ggplot(aes(x = log(Predator_mass), y = log(Prey_mass), colour = Specific_habitat)) +
   geom_point()+
    xlab("Log (Predator Mass)")+
    ylab("Log (Prey Mass)")+ 
    labs(color='Specific Habitat') +
    jrc_theme()


```




```{r, fig.width=8, fig.height=6, echo=FALSE,fig.cap=paste("Fig.4")}
# Fig. 2b

    
Pred %>%
    ggplot(aes(x = log(Predator_mass),
               y = log(Prey_mass),
               colour = Type_of_feeding_interaction)) +
    geom_point(size = 0.01) +
    facet_wrap(~ Specific_habitat) +
    geom_smooth(method = 'glm', colour = 'black', size = 0.5) +
      xlab("Log (Predator Mass)")+
    ylab("Log (Prey Mass)")+
    labs(color='Type of Feeding Interaction') +
    jrc_theme()
    

    
```


# Methods

Data was obtained from the “Marine predator and prey body sizes”, created by Barnes et al(2008).; joint venture generated by 17 different international institutions. As such, we have data from global locations on organisms and their environment. We focused on data on environmental variables to see which ones suggest a correlation with predator mass and prey mass. Our variables of interest were selected to be: specific habitat location and feeding behaviour.
 
Importing the dataset into R, we used the package ggplot2 to visualize the patterns and trend in the aforementioned variables. Three graphs were generated from the data. The first figure compares predator mass and prey mass. The second figure is a map graph representing the locations of all the 27 international marine locations where our data was obtained. Using the facet feature of ggplot2, the third figure visualized the affect of feeding behaviour and the specific location on the relationship of predator-prey mass ratios.
 
To determine which variables are affecting the slope of predator-prey mass relations, we generated several models. (using glm; and lmr; and mn <- talk about these later). Every model assumes that the predator mass are the independent variable, and the prey mass are the dependent variable. The first model was a control model; assuming that there was nothing affecting the interaction of predator-prey mass. The second model incorporates the effect of specific habitat on the intercept and slope of the predator-prey mass ratio. Fourth model incorporates the effect of feeding behaviour on the intercept and slope of the predator-prey mass ratio.  The third model incorporates the additive effect of both specific habitat and feeding behaviour. The sixth model incorporates the mixed effect of habitat on feeding behaviour in the predator-prey mass interaction. The seventh model incorporates the mixed effect of feeding behaviour in the mass interaction. The last model incorporates for “everything” (<- need more details). 

### Graphs 
```{r,warning=FALSE, include=FALSE}

filtered_dataset <- pred_prey_dataset %>% 
    filter(Type_of_feeding_interaction != 'insectivorous' & Type_of_feeding_interaction != 'predacious/piscivorous') %>% 
    filter(Specific_habitat != 'Coastal, SW & SE Greenland' & Specific_habitat != 'inshore' & Specific_habitat != 'Nearshore waters')


lm9 <- lmer(log(Prey_mass) ~ log(Predator_mass) + (1 | Type_of_feeding_interaction) + (1 | Type_of_feeding_interaction:Specific_habitat), data = filtered_dataset)

lm10 <- lmer(log(Prey_mass) ~ log(Predator_mass) + (1 + log(Predator_mass) | Type_of_feeding_interaction) + (1 + log(Predator_mass)| Type_of_feeding_interaction:Specific_habitat), data = filtered_dataset)

lm11 <- lmer(log(Prey_mass) ~ log(Predator_mass) + (1 + log(Predator_mass) | Specific_habitat) + (1 + log(Predator_mass)| Specific_habitat:Type_of_feeding_interaction), data = filtered_dataset)

lm12 <- lmer(log(Prey_mass) ~ log(Predator_mass) + (1 + log(Predator_mass) | Specific_habitat) + (1 + log(Predator_mass)| Specific_habitat:Type_of_feeding_interaction) + (1 + log(Predator_mass)| Type_of_feeding_interaction), data = filtered_dataset)


fitted_lm11 <- augment(lm11) 

null <- glm(log(Prey_mass) ~ log(Predator_mass),data = filtered_dataset) 
fitted_null <- augment(null) %>% 
    rename(.fitted_null = .fitted)
names(fitted_null)
null_line <- geom_line(aes(x = log.Predator_mass., y = .fitted_null))
nulllm11 <- bind_cols(fitted_lm11, fitted_null)

```



```{r, fig.width=8, fig.height=6, warning=FALSE, echo=FALSE}

    inter<- ggplot(nulllm11, aes(x = log.Predator_mass., y = .fitted)) +
    geom_line(aes(colour = Specific_habitat))+facet_grid(~ Type_of_feeding_interaction) + null_line +
    jrc_theme()+
    xlab("Log (Predator Mass)")+
    labs(colour = "Specific Habitat")+
    jrc_theme()
    
    

ggplotly(inter)
   
```


```{r,fig.width=9,warning=FALSE, echo=FALSE}

fitdata11 <- ranef(lm11)[[1]] %>% 
    rownames_to_column()%>% as_data_frame() %>% 
    separate(rowname, into = c("habitat","feeding_type"), sep = ":") 

colnames(fitdata11)[4] <- c("slope")

fitdata11 %>% 
    ggplot(aes(x = feeding_type, y = fixef(lm11)[[2]] + slope,color = habitat))+
    geom_point() + 
    geom_hline(yintercept = tidy(null)[2,2])+
    xlab("Type of Feeding")+
    ylab("Slope of log (Prey mass) vs Log (Predator Mass)")+
    labs(colour = "Habitat")+
    jrc_theme()





```



```{r,warning=FALSE, include=FALSE}
model.sel(lm9, lm10, lm11,null, lm12, rank = AIC)
```



```{r,warning=FALSE, echo=FALSE}

kable(model.sel(lm9, lm10, lm11,null, lm12, rank = AIC))
```

*Table.1: Results of our models*


```{r,warning=FALSE, echo=FALSE}

kable(anova(  lm9, lm10, lm11,null, lm12))
```


# Discussion





# Software
The software we used to create this document is the statistical Analysis program R.  The packages used to create this data are:

1)  tidyverse
2)  dplyer
3)  readxl
4)  broom
5)  lme4
6)  MuMIn
7)  knitr
8)  plotly


# References

1) Cohen, J. E., Pimm, S. L., Yodzis, P., & Saldana, J. (1993). *Body sizes of animal predators and animal prey in food webs*. Journal of Animal Ecology, 62, 67-78. doi:10.2307/5483

2) C. Barnes, D. M. Bethea, R. D. Brodeur, J. Spitz, V. Ridoux, C. Pusineri, B. C. Chase, M. E. Hunsicker, F. Juanes, A. Kellermann, J. Lancaster, F. M?nard, F.-X. Bard, P. Munk, J. K. Pinnegar, F. S. Scharf, R. A. Rountree, K. I. Stergiou, C. Sassa, A. Sabates, and S. Jennings. 2008. *Predator and prey body sizes in marine food webs*. Ecology 89:881.http://www.esapubs.org/archive/ecol/E089/051/metadata.htm

3) Tucker MA, Rogers TL. 2014, *Examining predator–prey body size, trophic level and body mass across marine and terrestrial mammals*. Proc. R. Soc. B 281:20142103., http://dx.doi.org/10.1098/rspb.2014.2103





